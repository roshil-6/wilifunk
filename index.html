<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WILIFUNK SPACE ROCKET</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="game-container">
        <!-- Game Canvas -->
        <div id="phaser-game"></div>

        <!-- In-Game UI -->
        <div id="gameUI" class="hidden">
            <button id="pauseBtn" class="game-btn pause-btn" title="Menu">‚ò∞</button>
        </div>

        <!-- Game Over Screen -->
        <div id="gameOverOverlay" class="overlay hidden">
            <div class="overlay-content">
                <div class="overlay-title game-over-title">CRASHED!</div>
                <div class="overlay-message" id="gameOverMessage">Your rocket couldn't make it...</div>
                <div class="overlay-stats" id="gameOverStats"></div>

                <!-- Name Entry for Leaderboard -->
                <div id="leaderboardEntry" class="hidden" style="margin-bottom: 20px;">
                    <input type="text" id="playerNameInput" placeholder="ENTER YOUR NAME" maxlength="15"
                        class="name-input">
                    <button id="saveScoreBtn" class="menu-button primary small" style="margin-top: 10px;">SAVE
                        SCORE</button>
                </div>
                <div class="overlay-buttons">
                    <button id="restartBtn" class="menu-button primary">LAUNCH AGAIN</button>
                    <button id="homeBtn" class="menu-button secondary">MENU</button>
                </div>
            </div>
        </div>

        <!-- Identify Pilot Popup (Pre-Game) -->
        <div id="identifyOverlay" class="overlay hidden">
            <div class="overlay-content">
                <div class="overlay-title" style="color: #00d4ff;">IDENTIFY PILOT</div>
                <div class="overlay-message">Sign the flight log to record your rank.</div>
                <div style="margin-bottom: 30px;">
                    <input type="text" id="pilotNameInput" placeholder="PILOT NAME" maxlength="15" class="name-input">
                </div>
                <div class="overlay-buttons">
                    <button id="confirmPilotBtn" class="menu-button primary">LAUNCH</button>
                    <button id="skipPilotBtn" class="menu-button secondary">SKIP & FLY</button>
                </div>
            </div>
        </div>

        <!-- Home Menu -->
        <div id="homeMenu" class="home-menu">
            <div class="home-content">
                <!-- Title Section -->
                <div class="title-section">
                    <div class="rocket-icon">üöÄ</div>
                    <h1 class="game-title">WILIFUNK SPACE ROCKET</h1>
                    <div id="pilotDisplay" class="pilot-info"
                        style="margin-bottom: 5px; color: #888; font-size: 14px; letter-spacing: 1px;">
                        PILOT: <span id="currentPilotName" style="color: #00d4ff; font-weight: bold;">---</span>
                        <a href="#" id="changePilotBtn"
                            style="color: #ff3366; margin-left: 10px; font-size: 11px; text-decoration: underline; cursor: pointer;">CHANGE</a>
                    </div>
                    <div id="syncStatus" style="font-size: 10px; color: #444; margin-bottom: 15px;">üõ∞Ô∏è Status: <span
                            id="syncText">Checking...</span></div>
                    <p class="tagline"><span id="taglineText">How far can you fly?</span></p>
                    <p class="challenge-text">Average pilots crash within 10 obstacles.</p>

                    <!-- Intensity Slider -->
                    <div class="intensity-control" style="margin-top: 30px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: #888; font-size: 14px; letter-spacing: 2px;">INTENSITY</span>
                            <span id="intensityValue"
                                style="color: #00d4ff; font-weight: bold; font-size: 18px;">25</span>
                        </div>
                        <input type="range" id="intensitySlider" min="10" max="50" value="25" class="intensity-slider">
                        <div id="intensityTagline" class="intensity-feedback">Steady as she goes.</div>
                    </div>

                    <div class="action-buttons"
                        style="display: flex; gap: 10px; justify-content: center; margin-top: 10px;">
                        <button id="mainStartBtn" class="start-button">üöÄ LAUNCH</button>
                    </div>
                </div>

                <!-- Multiplayer Menu (Hidden) -->
                <div id="multiplayerMenu" class="hidden"
                    style="margin-top: 20px; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px; border: 1px solid #8e44ad;">
                    <h2 style="color: #fff; margin-bottom: 20px;">MULTIPLAYER BATTLE</h2>
                    <div class="vs-stats"
                        style="display: flex; justify-content: center; gap: 30px; color: #fff; margin-bottom: 20px;">
                        <div>
                            <h3 style="color: #00d4ff;">P1</h3>
                            <div id="p1Wins" style="font-size: 30px; font-weight: bold;">0</div>
                        </div>
                        <div style="font-size: 24px; color: #ff3366; font-weight: bold; padding-top: 10px;">VS</div>
                        <div>
                            <h3 style="color: #ff3366;">P2</h3>
                            <div id="p2Wins" style="font-size: 30px; font-weight: bold;">0</div>
                        </div>
                    </div>
                    <p style="color: #aaa; font-size: 14px; margin-bottom: 20px;">P1: Bottom (Tap) | P2: Top (Tap)</p>
                    <button onclick="startMultiplayer()" class="start-button"
                        style="background: #e74c3c;">FIGHT!</button>
                    <button onclick="closeMultiplayer()"
                        style="background: none; border: none; color: #ccc; text-decoration: underline; margin-top: 10px; cursor: pointer;">Cancel</button>
                </div>

                <!-- Rules Section -->
                <div class="rules-section">
                    <h2 class="rules-title">CONTROLS</h2>
                    <div class="rules-simple">
                        <div class="rule-big">
                            <span class="key-icon">TAP</span>
                            <span class="or-text">or</span>
                            <span class="key-icon">SPACE</span>
                        </div>
                        <p class="rule-desc">to thrust upward</p>
                    </div>
                    <div class="rules-tips">
                        <p>‚ö†Ô∏è Avoid the barriers</p>
                        <p>‚≠ê Collect 3 Stars = üõ°Ô∏è Shield (5s)</p>
                        <p>üï≥Ô∏è Black Holes = ESCAPE or DIE</p>
                        <p>üèÜ Beat your high score</p>
                    </div>
                </div>

                <!-- Trophy Case -->
                <div class="trophy-section">
                    <h2 class="rules-title">TROPHY CASE</h2>
                    <div id="badgeContainer" class="badge-grid">
                        <p class="no-badges">No badges yet...</p>
                    </div>
                </div>

                <!-- Leaderboard Section -->
                <div class="leaderboard-section">
                    <h2 class="rules-title">TOP PILOTS</h2>
                    <div id="leaderboardList" class="leaderboard-list">
                        <p class="no-badges">Loading rankings...</p>
                    </div>
                </div>

                <!-- Start Button (Removed duplicate) -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <script src="game.js"></script>
    <script>
        // Menu Navigation
        const homeMenu = document.getElementById('homeMenu');
        const gameUI = document.getElementById('gameUI');
        const gameOverOverlay = document.getElementById('gameOverOverlay');

        // Start Game Flow
        const identifyOverlay = document.getElementById('identifyOverlay');
        const pilotNameInput = document.getElementById('pilotNameInput');

        // Pilot Management UI
        function updatePilotDisplay() {
            const name = localStorage.getItem('lastPlayerName') || 'UNKNOWN';
            const display = document.getElementById('currentPilotName');
            if (display) display.textContent = name;
        }

        document.getElementById('changePilotBtn')?.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('lastPlayerName');
            updatePilotDisplay();
            triggerStartFlow();
        });

        // Fail-safe Reset button
        window.resetApp = function () {
            if (confirm("Clear all data and reset pilot?")) {
                localStorage.clear();
                window.location.reload();
            }
        };

        // Initial update
        updatePilotDisplay();

        const triggerStartFlow = () => {
            const savedName = localStorage.getItem('lastPlayerName');
            console.log("Triggering start flow. Current saved name:", savedName);

            if (savedName && savedName !== 'RENEGADE' && savedName !== 'PILOT') {
                console.log("Auto-launching with stored name:", savedName);
                if (typeof window.setPlayerName === 'function') {
                    window.setPlayerName(savedName);
                    updatePilotDisplay();
                }
                launchGame();
            } else {
                console.log("Opening identification popup...");
                if (identifyOverlay) {
                    identifyOverlay.classList.remove('hidden');
                    if (pilotNameInput) {
                        pilotNameInput.value = savedName || '';
                        pilotNameInput.focus();
                    }
                } else {
                    console.error("Critical Error: identifyOverlay not found!");
                    launchGame(); // Emergency launch
                }
            }
        };

        document.getElementById('mainStartBtn')?.addEventListener('click', triggerStartFlow);

        document.getElementById('confirmPilotBtn').addEventListener('click', () => {
            const name = pilotNameInput.value.trim().toUpperCase();
            console.log("Confirming pilot name:", name);
            if (name) {
                localStorage.setItem('lastPlayerName', name);
                if (typeof window.setPlayerName === 'function') {
                    window.setPlayerName(name);
                }
            } else {
                if (typeof window.setPlayerName === 'function') {
                    window.setPlayerName('RENEGADE'); // Handle blank as RENEGADE
                }
            }
            launchGame();
        });

        document.getElementById('skipPilotBtn').addEventListener('click', () => {
            if (typeof window.setPlayerName === 'function') {
                window.setPlayerName('PILOT'); // Default name for skip
            }
            launchGame();
        });

        function launchGame() {
            console.log("Initializing Game UI transition...");
            if (identifyOverlay) identifyOverlay.classList.add('hidden');
            if (homeMenu) homeMenu.classList.add('hidden');
            if (gameUI) gameUI.classList.remove('hidden');
        }

        // Pause/Menu button
        document.getElementById('pauseBtn').addEventListener('click', () => {
            showHomeMenu();
        });

        // Intensity Handling
        const intensitySlider = document.getElementById('intensitySlider');
        const intensityValue = document.getElementById('intensityValue');
        const intensityTagline = document.getElementById('intensityTagline');

        // Load saved intensity
        const savedIntensity = localStorage.getItem('spaceRocketIntensity') || '25';
        intensitySlider.value = savedIntensity;
        intensityValue.textContent = savedIntensity;

        intensitySlider.addEventListener('input', (e) => {
            const val = e.target.value;
            intensityValue.textContent = val;
            localStorage.setItem('spaceRocketIntensity', val);
            updateIntensityFeedback(val);
        });

        function updateIntensityFeedback(val) {
            let feedback = "";
            let color = "#00d4ff";

            if (val <= 20) {
                const teases = [
                    "Too scared of the void?",
                    "Grandma mode activated.",
                    "Safe and boring, huh?",
                    "Training wheels on."
                ];
                feedback = teases[Math.floor(val / 5) % teases.length];
                color = "#ffdd59";
            } else if (val < 40) {
                feedback = "Steady as she goes.";
                color = "#00d4ff";
            } else {
                const apprec = [
                    "NOW WE'RE TALKING!",
                    "Absolute orbital madness.",
                    "You've got titanium nerves!",
                    "GLORY OR DEATH!"
                ];
                feedback = apprec[Math.floor((val - 40) / 3) % apprec.length];
                color = "#ff3366";
            }

            intensityTagline.textContent = feedback;
            intensityTagline.style.color = color;
            intensityValue.style.color = color;

            // Pulse effect
            intensityValue.style.transition = "none";
            intensityValue.style.transform = "scale(1.3)";
            setTimeout(() => {
                intensityValue.style.transition = "transform 0.2s ease";
                intensityValue.style.transform = "scale(1)";
            }, 50);
        }

        // Init feedback
        updateIntensityFeedback(savedIntensity);

        // Restart button
        document.getElementById('restartBtn')?.addEventListener('click', () => {
            gameOverOverlay.classList.add('hidden');
            if (typeof restartGame === 'function' && sceneRef) {
                restartGame(sceneRef);
            }
            // Auto-start after restart
            setTimeout(() => {
                if (typeof startGame === 'function') {
                    // Click to start
                }
            }, 100);
        });

        // Home button
        document.getElementById('homeBtn')?.addEventListener('click', showHomeMenu);

        function showHomeMenu() {
            homeMenu.classList.remove('hidden');
            gameUI.classList.add('hidden');
            gameOverOverlay.classList.add('hidden');

            // Refresh tagline based on new score
            if (typeof updateTagline === 'function') {
                updateTagline();
            }

            // Refresh leaderboard UI (Global refresh)
            if (typeof window.refreshLeaderboard === 'function') {
                window.refreshLeaderboard();
            } else if (typeof updateLeaderboardUI === 'function') {
                updateLeaderboardUI();
            }

            if (typeof restartGame === 'function' && sceneRef) {
                restartGame(sceneRef);
            }
        }

        // Expose function for game.js
        window.showGameOver = function (score, highScore) {
            gameOverOverlay.classList.remove('hidden');
            const isNewRecord = score >= highScore && score > 0;
            document.getElementById('gameOverMessage').textContent =
                isNewRecord ? 'üéâ NEW HIGH SCORE!' : 'Your rocket crashed...';
            document.getElementById('gameOverStats').innerHTML =
                `Score: <strong>${score}</strong> | Best: <strong>${highScore}</strong>`;

            // Show leaderboard entry if score > 0
            if (score > 0) {
                document.getElementById('leaderboardEntry').classList.remove('hidden');
                document.getElementById('playerNameInput').value = localStorage.getItem('lastPlayerName') || '';
            } else {
                document.getElementById('leaderboardEntry').classList.add('hidden');
            }
        };

        // Leaderboard Saving
        document.getElementById('saveScoreBtn').addEventListener('click', () => {
            const nameInput = document.getElementById('playerNameInput');
            const name = nameInput.value.trim().toUpperCase();

            if (!name) {
                nameInput.style.border = "1px solid red";
                setTimeout(() => nameInput.style.border = "1px solid #00d4ff", 1000);
                return;
            }

            localStorage.setItem('lastPlayerName', name);
            if (typeof saveToLeaderboard === 'function') {
                saveToLeaderboard(name);
                document.getElementById('leaderboardEntry').classList.add('hidden');
                // Show success feedback?
                document.getElementById('gameOverMessage').textContent = "SCORE SAVED! üöÄ";
            }
        });

        window.updateLeaderboardUI = function (leaderboard) {
            const list = document.getElementById('leaderboardList');
            if (!list) return;

            // Use provided data or fetch from localStorage
            let data = leaderboard;
            if (!data) {
                try {
                    const saved = localStorage.getItem('spaceRocketLeaderboard');
                    data = saved ? JSON.parse(saved) : [];
                } catch (e) {
                    console.error("Failed to parse leaderboard from localStorage:", e);
                    data = [];
                }
            }

            if (!data || !Array.isArray(data) || data.length === 0) {
                list.innerHTML = `<p class="no-badges">No records yet. Be the first!</p>`;
                return;
            }

            list.innerHTML = data.map((entry, index) => `
                <div class="leaderboard-item ${index < 3 ? 'top-rank' : ''}">
                    <span class="rank-number">#${index + 1}</span>
                    <span class="rank-name">${entry.name}</span>
                    <span class="rank-score">${entry.score}</span>
                </div>
            `).join('');
        };

        // Initial leaderboard update
        window.updateLeaderboardUI();
        // Dynamic Tagline based on High Score
        function updateTagline() {
            const score = parseInt(localStorage.getItem('spaceRocketHighScore') || '0');
            const tagElement = document.getElementById('taglineText');

            let text = "";

            if (score < 20) {
                text = "Your high score is a joke in 3 galaxies.";
            } else if (score < 50) {
                text = "Double digits? Someone's trying hard.";
            } else if (score < 100) {
                text = "Not terrible. But my cat could do better.";
            } else if (score < 200) {
                text = "Finally, a pilot who knows up from down.";
            } else if (score < 500) {
                text = "Okay, you're actually dangerous now.";
            } else {
                text = "The Universe touches its hat to you.";
            }

            tagElement.textContent = text;
            tagElement.style.opacity = 1;
        }

        // Run on load
        updateTagline();

        // Listen for updates from game
        window.updateBadgesUI = function () {
            // Re-run tagline update in case score changed
            updateTagline();
            // Also update badges if needed (existing logic might need merge if strict about function replacement)
        };
    </script>
</body>

</html>